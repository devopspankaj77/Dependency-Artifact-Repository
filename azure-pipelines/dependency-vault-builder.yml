# File: vault/pipelines/dependency-builder.yaml
trigger: none
pool: Default

parameters:
  - name: nodeVersion
    type: string
    default: '18'
  - name: azureServiceConnection
    type: string
    default: 'MyServiceConnection'
  - name: storageAccountName
    type: string
    default: 'mystorageacct'
  - name: containerName
    type: string
    default: 'artifacts'

variables:
  artifactName: 'node-dependencies-v${{ parameters.nodeVersion }}.zip'

stages:
  - stage: BuildNodeDependencies
    displayName: "Build Node Dependencies"
    jobs:
      - job: Build
        displayName: "Clean & Package Dependencies"
        steps:
          - checkout: self

          - task: NodeTool@0
            inputs:
              versionSpec: '${{ parameters.nodeVersion }}'
            displayName: "Setup Node.js ${{ parameters.nodeVersion }}"

          - script: |
              echo "✅ Default working directory: $(System.DefaultWorkingDirectory)"
              echo "Navigating to vault/node${{ parameters.nodeVersion }}"
              cd "$(System.DefaultWorkingDirectory)/vault/node${{ parameters.nodeVersion }}" || { echo "❌ Directory not found!"; exit 1; }
              node -v
              npm ci || { echo "❌ npm ci failed"; exit 1; }
              npm audit fix --force || true
              npm dedupe || true
              npm prune --production || true
              echo "✅ node_modules created successfully"
              ls -ld node_modules || echo "⚠️ node_modules not found!"
            displayName: "Clean and secure dependencies"

          - script: |
              echo "Verifying node_modules path..."
              ls -ld "$(System.DefaultWorkingDirectory)/vault/node${{ parameters.nodeVersion }}/node_modules" || { echo "❌ node_modules missing"; exit 1; }
            displayName: "Validate node_modules existence"

          - task: ArchiveFiles@2
            inputs:
              rootFolderOrFile: '$(System.DefaultWorkingDirectory)/vault/node${{ parameters.nodeVersion }}/node_modules'
              includeRootFolder: false
              archiveFile: '$(Build.ArtifactStagingDirectory)/node-dependencies-v${{ parameters.nodeVersion }}.zip'
            displayName: "Archive dependencies"

          - publish: '$(Build.ArtifactStagingDirectory)/node-dependencies-v${{ parameters.nodeVersion }}.zip'
            artifact: '${{ parameters.nodeVersion }}'
            displayName: "Publish dependency artifact"
