trigger:
  branches:
    include:
      - main
      - releases/*
      - feature/*
pr:
  branches:
    include:
      - main
      - releases/*
      - feature/*
parameters:
  - name: nodeVersion
    type: string
    default: '18'
    displayName: 'Node.js Version'

variables:
  artifactName: 'node-vault-$(nodeVersion)'
  storageContainer: 'node-vault'
  storageAccount: '<your-storage-account-name>'

pool: Default
stages:
  - stage: 
    jobs:
      - job: 
        steps:
        - task: NodeTool@0
          inputs:
            versionSource: 'spec'
            versionSpec: '${{ parameters.nodeVersion }}'
        - task: CmdLine@2
          inputs:
            script: |
              cd vault/node$(nodeVersion)
              echo "Installing dependencies..."
              npm ci
              echo "Running audit fix..."
              npm audit fix --force
              echo "Deduping & pruning..."
              npm dedupe
              npm prune --production
        - task: CmdLine@2
          inputs:
            script: 'npm audit --json > audit-report.json || true'
            workingDirectory: 'vault/node$(nodeVersion)'
        - task: CmdLine@2
          inputs:
            script: |
              tar -czf node-vault-node$(nodeVersion).tar.gz -C vault/node$(nodeVersion) node_modules package.json package-lock.json audit-report.json
              mkdir -p $(Build.ArtifactStagingDirectory)
              mv node-vault-node$(nodeVersion).tar.gz $(Build.ArtifactStagingDirectory)/
        - task: CmdLine@2
          inputs:
            script: |
              pathToPublish: '$(Build.ArtifactStagingDirectory)'
              artifactName: '$(artifactName)'
              publishLocation: 'Container'



  